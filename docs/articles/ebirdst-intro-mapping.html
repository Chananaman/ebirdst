<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ebirdst: Introduction to loading, mapping, and plotting eBird Status and Trend products • ebirdst</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">ebirdst</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/ebirdst-intro-mapping.html">Intro Vignette</a>
</li>
<li>
  <a href="../articles/ebirdst-pipd.html">Advanced Vignette</a>
</li>
<li>
  <a href="../reference/index.html">Function Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/CornellLabofOrnithology/ebirdst">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>ebirdst: Introduction to loading, mapping, and plotting eBird Status and Trend products</h1>
                        <h4 class="author">Tom Auer, Daniel Fink</h4>
            
            <h4 class="date">2018-12-12</h4>
          </div>

    
    
<div class="contents">
<style type="text/css">
.table {

    width: 50%;

}
</style>
<div id="outline" class="section level1">
<h1 class="hasAnchor">
<a href="#outline" class="anchor"></a>Outline</h1>
<ol style="list-style-type: decimal">
<li>Background</li>
<li>Projections and Loading Rasters</li>
<li>Mapping Occurrence and Abundance</li>
<li>Extracting Trajectories with Uncertainty</li>
<li>Conversion</li>
</ol>
</div>
<div id="background" class="section level1">
<h1 class="hasAnchor">
<a href="#background" class="anchor"></a>1. Background</h1>
<p>Many ecological and conservation problems require comprehensive, high-resolution information about the spatial and temporal distribution and abundance of species’ populations. This poses a challenge because observations of species are often sparsely and irregularly distributed, especially for widely distributed species. To address this challenge, species distribution models are used to estimate species’ distributions in unobserved locations and times. By associating local environmental characteristics with observed patterns of species occurrence and abundance statistical models provide a framework to harness available data and make estimates in unobserved areas. Additionally, these models can be used to control for known sources of biases that arise from the observation process.</p>
<p>The relative abundance estimates described here were based on bird observation data from <a href="www.ebird.org">eBird</a>, a citizen-science program administered by Cornell Lab of Ornithology, and local land cover descriptions derived from NASA MODIS and other remote sensing data. Individual species’ distributions and abundance were modeled using a spatio-temporal ensemble of boosted regression using the Spatio-Temporal Exploratory Model (STEM) framework (see Fink et al. 2010, 2014 and Johnston et al. 2015).</p>
<p>These models were then used to produce one daily abundance and occurrence estimate per week for all 52 weeks of the year. For each week, estimates were made across a regular grid of locations that cover terrestrial North America at a resolution of 2.8km x 2.8km. Variation in detectability associated with the search effort is controlled by standardizing the estimates to be the expected count of the species on a search conducted for one hour while traveling 1 km at the optimal time of day for detection of that species, on the given day at the given location by a skilled eBirder.</p>
<p>Each relative abundance estimate was computed as an ensemble average of up to 100 randomized base models. Averaging across an ensemble of base model estimates, each trained on random subsample of the data, produces a smoothed bootstrap (Efron 2014) or a bagged estimator. For each abundance estimate we also computed upper and lower limits as the 10th and 90th percentiles across the ensemble. These limits are conservative estimates of the sampling variation of the smoothed bootstrap estimator, for the reasons discussed in Efron (2014), and because they are based on subsamples of the full data set.</p>
<div id="data-access" class="section level2">
<h2 class="hasAnchor">
<a href="#data-access" class="anchor"></a>Data access</h2>
<p>TODO: Update data access</p>
<p><strong>DATA ACCESS HAS NOT BEEN PROVIDED TO DATE</strong></p>
</div>
<div id="data-structure-and-types" class="section level2">
<h2 class="hasAnchor">
<a href="#data-structure-and-types" class="anchor"></a>Data Structure and Types</h2>
<p>TODO: Add something about zeroes.</p>
<p><strong>IMPORTANT. AFTER DOWNLOADING THE RESULTS AND UNZIPPING THEM, DO NOT CHANGE THE FILE STRUCTURE.</strong> All functionality in this package relies on the structure inherent in the delivered results. Changing the folder and file structure will cause errors with this package. You can download the data to wherever you like, but you cannot change the structure within the folder.</p>
<p>eBird Status and Trends product abundance and occurrence estimates are currently provided in the widely used GeoTiff raster format. These are easily opened with the <code>raster</code> package in R, as well as with a variety of GIS software tools. The results are structured in the following way, with the abundance and occurrence estimate GeoTiff files for being found under the \&lt;six_letter_code-ERD2016-EBIRD_SCIENCE-date-uuid&gt;\results\tifs\ directory.</p>
<p>\&lt;six_letter_code-ERD2016-EBIRD_SCIENCE-date-uuid&gt;\data\ebird.abund_<six_letter_code-erd2016-ebird_science-date-uuid>_erd.test.data.csv \&lt;six_letter_code-ERD2016-EBIRD_SCIENCE-date-uuid&gt;\data\<six_letter_code-erd2016-ebird_science-date-uuid>_config.RData \&lt;six_letter_code-ERD2016-EBIRD_SCIENCE-date-uuid&gt;\data\<six_letter_code-erd2016-ebird_science-date-uuid>_srd_raster_template.tif \&lt;six_letter_code-ERD2016-EBIRD_SCIENCE-date-uuid&gt;\results\abund_preds\unpeeled_folds\pd.txt \&lt;six_letter_code-ERD2016-EBIRD_SCIENCE-date-uuid&gt;\results\abund_preds\unpeeled_folds\pi.txt \&lt;six_letter_code-ERD2016-EBIRD_SCIENCE-date-uuid&gt;\results\abund_preds\unpeeled_folds\summary.txt \&lt;six_letter_code-ERD2016-EBIRD_SCIENCE-date-uuid&gt;\results\abund_preds\unpeeled_folds\test.pred.ave.txt \&lt;six_letter_code-ERD2016-EBIRD_SCIENCE-date-uuid&gt;\results\tifs\<six_letter_code-erd2016-ebird_science-date-uuid>_hr_2016_abundance_umean.tif \&lt;six_letter_code-ERD2016-EBIRD_SCIENCE-date-uuid&gt;\results\tifs\<six_letter_code-erd2016-ebird_science-date-uuid>_hr_2016_abundance_upper.tif \&lt;six_letter_code-ERD2016-EBIRD_SCIENCE-date-uuid&gt;\results\tifs\<six_letter_code-erd2016-ebird_science-date-uuid>_hr_2016_abundance_lower.tif \&lt;six_letter_code-ERD2016-EBIRD_SCIENCE-date-uuid&gt;\results\tifs\<six_letter_code-erd2016-ebird_science-date-uuid>_hr_2016_occurrence_umean.tif \&lt;six_letter_code-ERD2016-EBIRD_SCIENCE-date-uuid&gt;\results\tifs\band_dates.csv</six_letter_code-erd2016-ebird_science-date-uuid></six_letter_code-erd2016-ebird_science-date-uuid></six_letter_code-erd2016-ebird_science-date-uuid></six_letter_code-erd2016-ebird_science-date-uuid></six_letter_code-erd2016-ebird_science-date-uuid></six_letter_code-erd2016-ebird_science-date-uuid></six_letter_code-erd2016-ebird_science-date-uuid></p>
</div>
<div id="raster-layer-descriptions" class="section level2">
<h2 class="hasAnchor">
<a href="#raster-layer-descriptions" class="anchor"></a>Raster Layer Descriptions</h2>
<table class="table">
<thead><tr class="header">
<th>Type</th>
<th>Measure</th>
<th>File Name</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>occurrence</td>
<td>trimmed mean</td>
<td>*_hr_2016_occurrence_umean.tif</td>
</tr>
<tr class="even">
<td>abundance</td>
<td>trimmed mean</td>
<td>*_hr_2016_abundance_umean.tif</td>
</tr>
<tr class="odd">
<td>abundance</td>
<td>10th quantile</td>
<td>*_hr_2016_abundance_lower.tif</td>
</tr>
<tr class="even">
<td>abundance</td>
<td>90th quantile</td>
<td>*_hr_2016_abundance_upper.tif</td>
</tr>
</tbody>
</table>
<div id="occurrence_umean" class="section level3">
<h3 class="hasAnchor">
<a href="#occurrence_umean" class="anchor"></a>occurrence_umean</h3>
<p>This layer represents the mean probability of occurrence, ranging from 0 to 1, for a 1-hour, 1-kilometre eBird checklist at the optimal time of day for detection of the species by a skilled eBirder.</p>
</div>
<div id="abundance_umean" class="section level3">
<h3 class="hasAnchor">
<a href="#abundance_umean" class="anchor"></a>abundance_umean</h3>
<p>This layer represents the mean estimated relative abundance of the species, defined as the expected number of birds encountered on a 1-hour, 1-kilometre eBird checklist at the optimal time of day for detection of the species by a skilled eBirder.</p>
</div>
<div id="abundance_lower" class="section level3">
<h3 class="hasAnchor">
<a href="#abundance_lower" class="anchor"></a>abundance_lower</h3>
<p>This layer represents the lower 10th quantile of the estimated relative abundance of the species, defined as the expected number of birds encountered on a 1-hour, 1-kilometre eBird checklist at the optimal time of day for detection of the species by a skilled eBirder.</p>
</div>
<div id="abundance_upper" class="section level3">
<h3 class="hasAnchor">
<a href="#abundance_upper" class="anchor"></a>abundance_upper</h3>
<p>This layer represents the upper 90th quantile of the estimated relative abundance of the species, defined as the expected number of birds encountered on a 1-hour, 1-kilometre eBird checklist at the optimal time of day for detection of the species by a skilled eBirder.</p>
</div>
</div>
</div>
<div id="projection-and-loading-rasters" class="section level1">
<h1 class="hasAnchor">
<a href="#projection-and-loading-rasters" class="anchor"></a>2. Projection and Loading Rasters</h1>
<div id="projection" class="section level2">
<h2 class="hasAnchor">
<a href="#projection" class="anchor"></a>Projection</h2>
<p>The GeoTiffs use the same Sinusoidal projection that the NASA MODIS data uses. As part of this package, we provide a template raster (\&lt;six_letter_code-ERD2016-EBIRD_SCIENCE-date-uuid&gt;\data\<six_letter_code-erd2016-ebird_science-date-uuid>_srd_raster_template.tif), that contains the spatial extent and resolution for the Western Hemisphere extent. Accessing this raster directly through the package is not necessary, but can be applied elsewhere (e.g., other GIS software).</six_letter_code-erd2016-ebird_science-date-uuid></p>
</div>
<div id="loading-rasters" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-rasters" class="anchor"></a>Loading Rasters</h2>
<p>Once you have downloaded a set of eBird Status and Trends products, one of the first tasks is to load one of the abundance or occurrence estimates into R in a way that they can easily be used. Each estimate is stored in a multi-band GeoTiff file and are most appropriately loaded as a <code>RasterStack</code> object. These “cubes” come with areas of predicted and assumed zeroes, such that any cells that are NA represent areas outside of the area of estimation. All cubes have 52 weeks, even if some weeks are all NA (such as those species that winter entirely outside of North America). The following code example shows how to load an estimate raster and assign names.</p>
<p>TODO: update data access.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># DOWNLOAD DATA</span>
<span class="co"># Currently, example data is available on a public s3 bucket. The following </span>
<span class="co"># download_data() function copies the species results to a selected path and </span>
<span class="co"># returns the full path of the results. Please note that the example_data is</span>
<span class="co"># for Yellow-bellied Sapsucker and has the same run code as the real data,</span>
<span class="co"># so if you download both, make sure you put the example_data somewhere else.</span>
species &lt;-<span class="st"> "yebsap-ERD2016-EBIRD_SCIENCE-20180729-7c8cec83"</span>
sp_path &lt;-<span class="st"> </span><span class="kw"><a href="../reference/download_data.html">download_data</a></span>(<span class="dt">species =</span> <span class="st">"example_data"</span>, <span class="dt">path =</span> <span class="st">"~/tmp/"</span>)
<span class="kw">print</span>(sp_path)</code></pre></div>
<pre><code>## [1] "/Users/mta45/tmp/yebsap-ERD2016-EBIRD_SCIENCE-20180729-7c8cec83"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load trimmed mean abundances and label dates</span>
abund_stack &lt;-<span class="st"> </span>raster::<span class="kw">stack</span>(<span class="kw">paste0</span>(sp_path, <span class="st">"/results/tifs/"</span>, species,
                               <span class="st">"_hr_2016_abundance_umean.tif"</span>))
abund_stack &lt;-<span class="st"> </span><span class="kw"><a href="../reference/label_raster_stack.html">label_raster_stack</a></span>(abund_stack)
<span class="kw">print</span>(abund_stack)</code></pre></div>
<pre><code>## class       : RasterStack 
## dimensions  : 259, 276, 71484, 52  (nrow, ncol, ncell, nlayers)
## resolution  : 2779.876, 2779.876  (x, y)
## extent      : -7202659, -6435414, 4636834, 5356822  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=sinu +lon_0=0 +x_0=0 +y_0=0 +a=6371007.181 +b=6371007.181 +units=m +no_defs 
## names       : X2016.01.04, X2016.01.11, X2016.01.18, X2016.01.25, X2016.02.01, X2016.02.08, X2016.02.15, X2016.02.22, X2016.03.01, X2016.03.08, X2016.03.15, X2016.03.22, X2016.03.29, X2016.04.05, X2016.04.12, ... 
## min values  :   0.0000000,   0.0000000,   0.0000000,   0.0000000,   0.0000000,   0.0000000,   0.0000000,   0.0000000,   0.0000000,   0.0000000,   0.0000000,   0.0000000,   0.0000000,   0.0000000,   0.5802106, ... 
## max values  :   0.8549717,   0.8846672,   0.9409274,   0.9427117,   0.8812727,   0.8041122,   0.8244059,   0.6452407,   0.6917557,   0.7189543,   0.6893005,   0.7716944,   0.9601365,   1.7183727,   2.5218585, ...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Note: if you want to work with a proper Date vector for the raster </span>
<span class="co"># dates, use parse_raster_dates()</span>
date_vector &lt;-<span class="st"> </span><span class="kw"><a href="../reference/parse_raster_dates.html">parse_raster_dates</a></span>(abund_stack)
<span class="kw">print</span>(date_vector)</code></pre></div>
<pre><code>##  [1] "2016-01-04" "2016-01-11" "2016-01-18" "2016-01-25" "2016-02-01"
##  [6] "2016-02-08" "2016-02-15" "2016-02-22" "2016-03-01" "2016-03-08"
## [11] "2016-03-15" "2016-03-22" "2016-03-29" "2016-04-05" "2016-04-12"
## [16] "2016-04-19" "2016-04-26" "2016-05-03" "2016-05-10" "2016-05-17"
## [21] "2016-05-24" "2016-05-31" "2016-06-07" "2016-06-14" "2016-06-21"
## [26] "2016-06-28" "2016-07-06" "2016-07-13" "2016-07-20" "2016-07-27"
## [31] "2016-08-03" "2016-08-10" "2016-08-17" "2016-08-24" "2016-08-31"
## [36] "2016-09-07" "2016-09-14" "2016-09-21" "2016-09-28" "2016-10-05"
## [41] "2016-10-12" "2016-10-19" "2016-10-26" "2016-11-02" "2016-11-09"
## [46] "2016-11-16" "2016-11-23" "2016-11-30" "2016-12-07" "2016-12-14"
## [51] "2016-12-21" "2016-12-28"</code></pre>
</div>
</div>
<div id="mapping-occurrence-and-abundance" class="section level1">
<h1 class="hasAnchor">
<a href="#mapping-occurrence-and-abundance" class="anchor"></a>3. Mapping Occurrence and Abundance</h1>
<p>One of the most common tasks with eBird Status and Trends products is to make maps of occurrence and abundance. It is fast and easy to make maps with limited code, but to get ideal maps takes extra preparation. This section describes some functions in the <code>ebirdst</code> package intended to assist with mapping.</p>
<div id="projections" class="section level2">
<h2 class="hasAnchor">
<a href="#projections" class="anchor"></a>Projections</h2>
<p>The sinusoidal projection that NASA provides MODIS data in, while functional because of its equal-area property, is not good for mapping because of the significant distortion of land masses across the globe. In general, there are few global equal-area projections, including, but not limited to, Lambert Azimuthal Equal Area, Goode Homolosine, Mollweide, and Equal Area Cylindrical. Of these, we have selected Mollweide, used in the remainder of this section, for its pleasing conformal properties across the globe, ease of projection configuration within R and its proj4string construction, and the ease of setting central meridians that best display the Western Hemisphere. It is worth noting that while projecting to a more visually appealing projection is ideal for mapping, it is not necessary for quantitative analysis of eBird Status and Trends products, for which purposes the results can be left in the original Sinusoidal projection.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(viridis)
<span class="kw">library</span>(raster)

<span class="co"># define mollweide projection</span>
mollweide &lt;-<span class="st"> </span><span class="kw">CRS</span>(<span class="st">"+proj=moll +lon_0=-90 +x_0=0 +y_0=0 +ellps=WGS84"</span>)

<span class="co"># project single layer from stack to mollweide</span>
week38_moll &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/projectRaster">projectRaster</a></span>(abund_stack[[<span class="dv">38</span>]], <span class="dt">crs =</span> mollweide, <span class="dt">method =</span> <span class="st">'ngb'</span>)

<span class="co"># optionally, you can project an entire stack, but it takes much longer</span>
<span class="co">#abund_stack_moll &lt;- projectRaster(abund_stack, crs = mollweide, method = 'ngb')</span>

<span class="co"># map single layer with full annual extent</span>
<span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">2</span>))
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(week38_moll, <span class="dt">xaxt =</span> <span class="st">'n'</span>, <span class="dt">yaxt =</span> <span class="st">'n'</span>, <span class="dt">bty =</span> <span class="st">'n'</span>, <span class="dt">col =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">plasma</a></span>(<span class="dv">10</span>),
     <span class="dt">maxpixels =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/ncell">ncell</a></span>(week38_moll))</code></pre></div>
<p><img src="ebirdst-intro-mapping_files/figure-html/project_stack-1.png" width="\textwidth" style="display: block; margin: auto;"></p>
<p>If working with a full set of data for a species, mapping the layer at the full spatial extent of the analysis area makes for a small map. The raster cube has zeroes for our prediction extent and NAs for the entire Western Hemisphere, unifying the weeks in a cube to the same extent. However, this also means that mapping defaults to the full spatial extent of NAs, the Western Hemisphere. To assist with this, project the <code>RasterStack</code> or <code>RasterLayer</code> to Mollweide, then calculate the full annual spatial extent for the species with the <code><a href="../reference/calc_full_extent.html">calc_full_extent()</a></code> function, and then map, showing an extent that works for the entire full-annual cycle of the species.</p>
</div>
<div id="mapping-occurrence" class="section level2">
<h2 class="hasAnchor">
<a href="#mapping-occurrence" class="anchor"></a>Mapping Occurrence</h2>
<p>Most examples in this vignette focus primarily on relative abundance estimates, as they’re the most novel and informative. However, we also provide estimates for the probability of occurrence. These are much simpler to map than abundance in terms of color scales and binning, as values range between 0 and 1 throughout the year.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">occ_stack &lt;-<span class="st"> </span>raster::<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/stack">stack</a></span>(<span class="kw">paste0</span>(sp_path, <span class="st">"/results/tifs/"</span>, species,
                               <span class="st">"_hr_2016_occurrence_umean.tif"</span>))
occ_stack &lt;-<span class="st"> </span><span class="kw"><a href="../reference/label_raster_stack.html">label_raster_stack</a></span>(occ_stack)
occ_week &lt;-<span class="st"> </span>occ_stack[[<span class="dv">26</span>]]

<span class="co"># create breaks every 0.05 from 0 to 1</span>
occ_bins &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">by =</span> <span class="fl">0.05</span>)
occ_week26 &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/projectRaster">projectRaster</a></span>(occ_week, <span class="dt">crs =</span> mollweide, <span class="dt">method =</span> <span class="st">'ngb'</span>)

<span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">2</span>), <span class="dt">cex =</span> <span class="fl">0.9</span>)
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(occ_week26, <span class="dt">xaxt =</span> <span class="st">'n'</span>, <span class="dt">yaxt =</span> <span class="st">'n'</span>, <span class="dt">bty =</span> <span class="st">'n'</span>, <span class="dt">breaks =</span> occ_bins,
     <span class="dt">col =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">plasma</a></span>(<span class="kw">length</span>(occ_bins) -<span class="st"> </span><span class="dv">1</span>), <span class="dt">maxpixels =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/ncell">ncell</a></span>(occ_week26),
     <span class="dt">legend.width =</span> <span class="dv">2</span>, <span class="dt">legend.shrink =</span> <span class="fl">0.97</span>)</code></pre></div>
<p><img src="ebirdst-intro-mapping_files/figure-html/map_occurrence-1.png" width="\textwidth" style="display: block; margin: auto;"></p>
</div>
<div id="calculating-abundance-bins" class="section level2">
<h2 class="hasAnchor">
<a href="#calculating-abundance-bins" class="anchor"></a>Calculating Abundance Bins</h2>
<p>Mapping relative abundance estimates across the full-annual cycle presents a challenge, in that patterns of concentration and dispersal in abundance change throughout the year, making it difficult to define color bins that suit all seasons and accurately reflect the detail of abundance predictions. To address this, we selected a method (described by Maciejewski et al. 2013) that does a Box-Cox power transformation of the entire year of data, constructs bins with the transformed data using standard deviations, and then un-transforms the bins.</p>
<p>To compare, we first scale the colors linearly, based on the maximum from the entire year. Since the max is quite high, times of the year with low concentration appear flat.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">year_max &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extremeValues">maxValue</a></span>(abund_stack), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)

week14_moll &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/projectRaster">projectRaster</a></span>(abund_stack[[<span class="dv">14</span>]], <span class="dt">crs =</span> mollweide, <span class="dt">method =</span> <span class="st">'ngb'</span>)

<span class="co"># set graphical params</span>
<span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))

<span class="co"># adding this extent to the background provides a better extent for the example</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(<span class="kw">as</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extent">extent</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/trim">trim</a></span>(week38_moll, <span class="dt">values =</span> <span class="ot">NA</span>)), <span class="st">"SpatialPolygons"</span>), 
     <span class="dt">col =</span> <span class="st">'white'</span>, <span class="dt">border =</span> <span class="st">'white'</span>)
<span class="co"># plot the abundance</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(week38_moll, <span class="dt">xaxt =</span> <span class="st">'n'</span>, <span class="dt">yaxt =</span> <span class="st">'n'</span>, <span class="dt">bty =</span> <span class="st">'n'</span>, <span class="dt">zlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, year_max),
     <span class="dt">col =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">plasma</a></span>(<span class="dv">20</span>), <span class="dt">maxpixels =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/ncell">ncell</a></span>(week38_moll), <span class="dt">legend =</span> <span class="ot">FALSE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)

<span class="co"># do the same for week 14</span>
<span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">4</span>))
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(<span class="kw">as</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extent">extent</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/trim">trim</a></span>(week38_moll, <span class="dt">values =</span> <span class="ot">NA</span>)), <span class="st">"SpatialPolygons"</span>), 
     <span class="dt">col =</span> <span class="st">'white'</span>, <span class="dt">border =</span> <span class="st">'white'</span>)
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(week14_moll, <span class="dt">xaxt =</span> <span class="st">'n'</span>, <span class="dt">yaxt =</span> <span class="st">'n'</span>, <span class="dt">bty =</span> <span class="st">'n'</span>, <span class="dt">zlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, year_max),
     <span class="dt">col =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">plasma</a></span>(<span class="dv">20</span>), <span class="dt">maxpixels =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/ncell">ncell</a></span>(week14_moll), <span class="dt">legend.shrink =</span> <span class="fl">0.97</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="ebirdst-intro-mapping_files/figure-html/map_linear-1.png" width="\textwidth" style="display: block; margin: auto;"></p>
<p>We can compare this with maps made using the <code><a href="../reference/calc_bins.html">calc_bins()</a></code> method.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># calculate ideal color bins for abundance values</span>
year_bins &lt;-<span class="st"> </span><span class="kw"><a href="../reference/calc_bins.html">calc_bins</a></span>(abund_stack)

<span class="co"># plot</span>
<span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">6</span>))
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(<span class="kw">as</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extent">extent</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/trim">trim</a></span>(week38_moll, <span class="dt">values =</span> <span class="ot">NA</span>)), <span class="st">"SpatialPolygons"</span>), 
     <span class="dt">col =</span> <span class="st">'white'</span>, <span class="dt">border =</span> <span class="st">'white'</span>)
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(week38_moll, <span class="dt">xaxt =</span> <span class="st">'n'</span>, <span class="dt">yaxt =</span> <span class="st">'n'</span>, <span class="dt">bty =</span> <span class="st">'n'</span>, <span class="dt">breaks =</span> year_bins$bins,
     <span class="dt">col =</span> viridis::<span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">plasma</a></span>(<span class="kw">length</span>(year_bins$bins) -<span class="st"> </span><span class="dv">1</span>), 
     <span class="dt">maxpixels =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/ncell">ncell</a></span>(week38_moll), <span class="dt">legend =</span> <span class="ot">FALSE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">6</span>))
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(<span class="kw">as</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extent">extent</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/trim">trim</a></span>(week38_moll, <span class="dt">values =</span> <span class="ot">NA</span>)), <span class="st">"SpatialPolygons"</span>), 
     <span class="dt">col =</span> <span class="st">'white'</span>, <span class="dt">border =</span> <span class="st">'white'</span>)
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(week14_moll, <span class="dt">xaxt =</span> <span class="st">'n'</span>, <span class="dt">yaxt =</span> <span class="st">'n'</span>, <span class="dt">bty =</span> <span class="st">'n'</span>, <span class="dt">breaks =</span> year_bins$bins,
     <span class="dt">col =</span> viridis::<span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">plasma</a></span>(<span class="kw">length</span>(year_bins$bins) -<span class="st"> </span><span class="dv">1</span>), 
     <span class="dt">maxpixels =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/ncell">ncell</a></span>(week14_moll), <span class="dt">legend =</span> <span class="ot">FALSE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)

<span class="co"># create a thinner set of labels</span>
bin_labels &lt;-<span class="st"> </span><span class="kw">format</span>(<span class="kw">round</span>(year_bins$bins, <span class="dv">2</span>), <span class="dt">nsmall =</span> <span class="dv">2</span>)
bin_labels[!(bin_labels %in%<span class="st"> </span><span class="kw">c</span>(bin_labels[<span class="dv">1</span>],
                               bin_labels[<span class="kw">round</span>((<span class="kw">length</span>(bin_labels) /<span class="st"> </span><span class="dv">2</span>)) +<span class="st"> </span><span class="dv">1</span>],
                               bin_labels[<span class="kw">length</span>(bin_labels)]))] &lt;-<span class="st"> ""</span>

<span class="co"># plot legend</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(week38_moll ^<span class="st"> </span>year_bins$power, 
     <span class="dt">col =</span> viridis::<span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">plasma</a></span>(<span class="kw">length</span>(year_bins$bins) -<span class="st"> </span><span class="dv">1</span>), <span class="dt">legend.only =</span> <span class="ot">TRUE</span>, 
     <span class="dt">breaks =</span> year_bins$bins ^<span class="st"> </span>year_bins$power, <span class="dt">lab.breaks =</span> bin_labels,
     <span class="dt">legend.shrink =</span> <span class="fl">0.97</span>, <span class="dt">legend.width =</span> <span class="dv">2</span>,  <span class="dt">axis.args =</span> <span class="kw">list</span>(<span class="dt">cex.axis =</span> <span class="fl">0.9</span>, 
                                                               <span class="dt">lwd.ticks =</span> <span class="dv">0</span>))</code></pre></div>
<p><img src="ebirdst-intro-mapping_files/figure-html/map_bins-1.png" width="\textwidth" style="display: block; margin: auto;"></p>
</div>
<div id="mapping-abundance" class="section level2">
<h2 class="hasAnchor">
<a href="#mapping-abundance" class="anchor"></a>Mapping Abundance</h2>
<p>As seen in the map above, the <code>calc_bins</code> method excludes zeroes. However, with color bins that accurately represent the data distribution, we can add in details about zeroes, tweak the legend, and add some reference data to make a complete map. Like the quick start guide, this will show you how to download example data and plot abundance values similar to how they are plotted for the <a href="https://ebird.org/science/status-and-trends/woothr/abundance-map-weekly">eBird Status and Trends Abundance animations</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rnaturalearth)

<span class="co"># to add context, let's pull in some reference data to add</span>
wh &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rnaturalearth/topics/ne_countries">ne_countries</a></span>(<span class="dt">continent =</span> <span class="kw">c</span>(<span class="st">"North America"</span>, <span class="st">"South America"</span>))
wh_states &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rnaturalearth/topics/ne_states">ne_states</a></span>(<span class="dt">iso_a2 =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/unique">unique</a></span>(wh@data$iso_a2))
wh_moll &lt;-<span class="st"> </span><span class="kw">spTransform</span>(wh, mollweide)
wh_states_moll &lt;-<span class="st"> </span><span class="kw">spTransform</span>(wh_states, mollweide)

week26_moll &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/projectRaster">projectRaster</a></span>(abund_stack[[<span class="dv">26</span>]], <span class="dt">crs =</span> mollweide, <span class="dt">method =</span> <span class="st">'ngb'</span>)

<span class="co"># set graphics params</span>
<span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">6</span>))

<span class="co"># use the extent object to set the spatial extent for the plot</span>
<span class="co"># use the extent object to set the spatial extent for the plot</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(<span class="kw">as</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extent">extent</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/trim">trim</a></span>(week26_moll, <span class="dt">values =</span> <span class="ot">NA</span>)), <span class="st">"SpatialPolygons"</span>), 
     <span class="dt">col =</span> <span class="st">'white'</span>, <span class="dt">border =</span> <span class="st">'white'</span>)

<span class="co"># add background spatial context</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(wh_states_moll, <span class="dt">col =</span> <span class="st">"#eeeeee"</span>, <span class="dt">border =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)

<span class="co"># plot zeroes as gray</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(week26_moll ==<span class="st"> </span><span class="dv">0</span>, <span class="dt">maxpixels =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/ncell">ncell</a></span>(week26_moll),
     <span class="dt">ext =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extent">extent</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/trim">trim</a></span>(week26_moll, <span class="dt">values =</span> <span class="ot">NA</span>)), <span class="dt">col =</span> <span class="st">'#dddddd'</span>, 
     <span class="dt">xaxt =</span> <span class="st">'n'</span>, <span class="dt">yaxt =</span> <span class="st">'n'</span>, <span class="dt">legend =</span> <span class="ot">FALSE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)

<span class="co"># define color bins</span>
these_cols &lt;-<span class="st"> </span><span class="kw">rev</span>(viridis::<span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">plasma</a></span>(<span class="kw">length</span>(year_bins$bins) -<span class="st"> </span><span class="dv">2</span>, <span class="dt">end =</span> <span class="fl">0.9</span>))
grayInt &lt;-<span class="st"> </span><span class="kw">colorRampPalette</span>(<span class="kw">c</span>(<span class="st">"#dddddd"</span>, these_cols[<span class="dv">1</span>]))
qcol &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">grayInt</span>(<span class="dv">4</span>)[<span class="dv">2</span>], these_cols)

<span class="co"># plot abundances</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(week26_moll, <span class="dt">maxpixels =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/ncell">ncell</a></span>(week26_moll),
     <span class="dt">ext =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extent">extent</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/trim">trim</a></span>(week26_moll, <span class="dt">values =</span> <span class="ot">NA</span>)), <span class="dt">breaks =</span> year_bins$bins,
     <span class="dt">col =</span> qcol, <span class="dt">xaxt =</span> <span class="st">'n'</span>, <span class="dt">yaxt =</span> <span class="st">'n'</span>, <span class="dt">legend =</span> <span class="ot">FALSE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)

<span class="co"># for legend, create a smaller set of bin labels</span>
bin_labels &lt;-<span class="st"> </span><span class="kw">format</span>(<span class="kw">round</span>(year_bins$bins, <span class="dv">2</span>), <span class="dt">nsmall =</span> <span class="dv">2</span>)
bin_labels[!(bin_labels %in%<span class="st"> </span><span class="kw">c</span>(bin_labels[<span class="dv">1</span>],
                               bin_labels[<span class="kw">round</span>((<span class="kw">length</span>(bin_labels) /<span class="st"> </span><span class="dv">2</span>)) +<span class="st"> </span><span class="dv">1</span>],
                               bin_labels[<span class="kw">length</span>(bin_labels)]))] &lt;-<span class="st"> ""</span>
bin_labels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"0"</span>, bin_labels)

<span class="co"># create colors that include gray for 0</span>
lcol &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'#dddddd'</span>, qcol)

<span class="co"># set legend such that color ramp appears linearly</span>
ltq &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> year_bins$bins[<span class="dv">1</span>], <span class="dt">to =</span> year_bins$bins[<span class="kw">length</span>(year_bins$bins)],
           <span class="dt">length.out =</span> <span class="kw">length</span>(year_bins$bins))
ltq &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, ltq)

<span class="co"># plot legend</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(week26_moll ^<span class="st"> </span>year_bins$power, <span class="dt">col =</span> lcol, <span class="dt">legend.only =</span> <span class="ot">TRUE</span>,
     <span class="dt">breaks =</span> ltq ^<span class="st"> </span>year_bins$power, <span class="dt">lab.breaks =</span> bin_labels, <span class="dt">legend.shrink =</span> <span class="fl">0.97</span>,
     <span class="dt">legend.width =</span> <span class="dv">2</span>, <span class="dt">axis.args =</span> <span class="kw">list</span>(<span class="dt">cex.axis =</span> <span class="fl">0.9</span>, <span class="dt">lwd.ticks =</span> <span class="dv">0</span>))

<span class="co"># add state boundaries on top</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(wh_states_moll, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="st">'white'</span>, <span class="dt">lwd =</span> <span class="fl">1.5</span>)</code></pre></div>
<p><img src="ebirdst-intro-mapping_files/figure-html/map_w_es-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div id="mapping-abundance-confidence-intervals" class="section level2">
<h2 class="hasAnchor">
<a href="#mapping-abundance-confidence-intervals" class="anchor"></a>Mapping Abundance Confidence Intervals</h2>
<p>In addition to occurrence and abundance estimates, we also provide confidence intervals at an upper value of 90% and lower value of 10%. These can be used to calculate and map a confidence band width.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load lower and upper stacks</span>
<span class="co"># load trimmed mean abundances and label dates</span>
lower_stack &lt;-<span class="st"> </span>raster::<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/stack">stack</a></span>(<span class="kw">paste0</span>(sp_path, <span class="st">"/results/tifs/"</span>, species,
                               <span class="st">"_hr_2016_abundance_lower.tif"</span>))
upper_stack &lt;-<span class="st"> </span>raster::<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/stack">stack</a></span>(<span class="kw">paste0</span>(sp_path, <span class="st">"/results/tifs/"</span>, species,
                               <span class="st">"_hr_2016_abundance_upper.tif"</span>))

<span class="co"># calculate band width</span>
conf_band &lt;-<span class="st"> </span>upper_stack[[<span class="dv">26</span>]] -<span class="st"> </span>lower_stack[[<span class="dv">26</span>]]

conf_week26 &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/projectRaster">projectRaster</a></span>(conf_band, <span class="dt">crs =</span> mollweide, <span class="dt">method =</span> <span class="st">'ngb'</span>)

<span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">2</span>))
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(conf_week26, <span class="dt">xaxt =</span> <span class="st">'n'</span>, <span class="dt">yaxt =</span> <span class="st">'n'</span>, <span class="dt">bty =</span> <span class="st">'n'</span>, <span class="dt">col =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">magma</a></span>(<span class="dv">20</span>),
     <span class="dt">maxpixel =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/ncell">ncell</a></span>(conf_week26))</code></pre></div>
<p><img src="ebirdst-intro-mapping_files/figure-html/map_confidence_band-1.png" width="\textwidth" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="extracting-trajectories-with-uncertainty" class="section level1">
<h1 class="hasAnchor">
<a href="#extracting-trajectories-with-uncertainty" class="anchor"></a>4. Extracting Trajectories with Uncertainty</h1>
<p>With <code>RasterStacks</code> for relative abundance estimates, as well as upper and lower confidence intervals, we can extract an abundance trajectory with uncertainty intervals and plot them across the year for a single location.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># set a point</span>
coords &lt;-<span class="st"> </span><span class="kw">cbind</span>(-<span class="fl">88.1</span>, <span class="fl">46.7</span>)
pt &lt;-<span class="st"> </span><span class="kw">SpatialPoints</span>(coords, <span class="dt">proj4string =</span> <span class="kw">CRS</span>(<span class="st">"+init=epsg:4326"</span>))
pt_prj &lt;-<span class="st"> </span><span class="kw">spTransform</span>(pt, <span class="kw">CRS</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/projection">proj4string</a></span>(abund_stack)))

<span class="co"># extract</span>
abund_traj &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extract">extract</a></span>(abund_stack, pt_prj, <span class="dt">fun =</span> mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
upper_traj &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extract">extract</a></span>(upper_stack, pt_prj, <span class="dt">fun =</span> mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
lower_traj &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extract">extract</a></span>(lower_stack, pt_prj, <span class="dt">fun =</span> mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))

<span class="co"># Plot trajectories</span>
<span class="kw">library</span>(ggplot2)

plot_frame &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span>:<span class="kw">length</span>(abund_traj),
                         <span class="dt">y =</span> <span class="kw">c</span>(<span class="kw">unname</span>(abund_traj)),
                         <span class="dt">upper =</span> <span class="kw">c</span>(<span class="kw">unname</span>(upper_traj)),
                         <span class="dt">lower =</span> <span class="kw">c</span>(<span class="kw">unname</span>(lower_traj)))

g &lt;-<span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(plot_frame, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x, y)) +
<span class="st">     </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="dt">data =</span> plot_frame) +
<span class="st">     </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span>(<span class="dt">data =</span> plot_frame, 
                 <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper), 
                 <span class="dt">alpha =</span> <span class="fl">0.3</span>) +
<span class="st">     </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Expected Count (count/(km hr))"</span>) +
<span class="st">     </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Week"</span>) +
<span class="st">     </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_light</a></span>()
g</code></pre></div>
<p><img src="ebirdst-intro-mapping_files/figure-html/trajectories-1.png" width="\textwidth" style="display: block; margin: auto;"></p>
<p>It is also possible to extract trajectories for regions, but it takes a little more data work.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># set an extent based on polygon</span>
mi &lt;-<span class="st"> </span>wh_states[!<span class="kw">is.na</span>(wh_states$name) &amp;<span class="st"> </span>wh_states$name ==<span class="st"> "Michigan"</span>, ]

<span class="co"># extract</span>
<span class="co"># because we're using a region, we get lots of values that we need to average together</span>
abund_traj &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extract">extract</a></span>(abund_stack, mi, <span class="dt">fun =</span> mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
abund_traj &lt;-<span class="st"> </span><span class="kw">apply</span>(abund_traj, <span class="dv">2</span>, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)

upper_traj &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extract">extract</a></span>(upper_stack, mi, <span class="dt">fun =</span> mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
upper_traj &lt;-<span class="st"> </span><span class="kw">apply</span>(upper_traj, <span class="dv">2</span>, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)

lower_traj &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/extract">extract</a></span>(lower_stack, mi, <span class="dt">fun =</span> mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
lower_traj &lt;-<span class="st"> </span><span class="kw">apply</span>(lower_traj, <span class="dv">2</span>, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)

<span class="co"># Plot trajectories</span>
<span class="kw">library</span>(ggplot2)

plot_frame &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span>:<span class="kw">length</span>(abund_traj),
                         <span class="dt">y =</span> <span class="kw">c</span>(<span class="kw">unname</span>(abund_traj)),
                         <span class="dt">upper =</span> <span class="kw">c</span>(<span class="kw">unname</span>(upper_traj)),
                         <span class="dt">lower =</span> <span class="kw">c</span>(<span class="kw">unname</span>(lower_traj)))

g &lt;-<span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(plot_frame, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x, y)) +
<span class="st">     </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="dt">data =</span> plot_frame) +
<span class="st">     </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span>(<span class="dt">data =</span> plot_frame, 
                 <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">ymin =</span> lower, <span class="dt">ymax =</span>upper), 
                 <span class="dt">alpha =</span> <span class="fl">0.3</span>) +
<span class="st">     </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Expected Count (count/(km hr))"</span>) +
<span class="st">     </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Week"</span>) +
<span class="st">     </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_light</a></span>()
g</code></pre></div>
<p><img src="ebirdst-intro-mapping_files/figure-html/trajectories_region-1.png" width="\textwidth" style="display: block; margin: auto;"></p>
</div>
<div id="conversion" class="section level1">
<h1 class="hasAnchor">
<a href="#conversion" class="anchor"></a>5. Conversion</h1>
<p>The <code>raster</code> package has a lot of functionality and the <code>RasterLayer</code> format is useful for spatial analysis and mapping, but some users do not have GIS experience or want the data in a simpler format for their preferred method of analysis. There are multiple ways to get more basic representations of the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># To convert the data to a simpler geographic format and access tabularly   </span>
<span class="co"># reproject into geographic (decimal degrees) </span>
abund_stack_ll &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/projectRaster">projectRaster</a></span>(abund_stack[[<span class="dv">26</span>]], <span class="dt">crs =</span> <span class="kw">CRS</span>(<span class="st">"+init=epsg:4326"</span>), 
                                <span class="dt">method =</span> <span class="st">'ngb'</span>)

<span class="co"># Convert raster object into a matrix</span>
p &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/rasterToPoints">rasterToPoints</a></span>(abund_stack_ll)
<span class="kw">colnames</span>(p) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>, <span class="st">"abundance_umean"</span>)
<span class="kw"><a href="http://www.rdocumentation.org/packages/raster/topics/headtail">head</a></span>(p)</code></pre></div>
<pre><code>##      longitude latitude abundance_umean
## [1,] -88.53912  48.1625       0.0000000
## [2,] -88.50382  48.1625       0.0000000
## [3,] -88.64502  48.1375       0.0000000
## [4,] -88.60972  48.1375       0.0000000
## [5,] -88.57442  48.1375       0.6022081
## [6,] -88.53912  48.1375       0.4725851</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Write a CSV file of the matrix</span>
<span class="kw">write.csv</span>(p, <span class="dt">file =</span> <span class="st">"yebsap_week26.csv"</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</code></pre></div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>Ross Maciejewski, Avin Pattah, Sungahn Ko, Ryan Hafen, William S. Cleveland, David S. Ebert. Automated Box-Cox Transformations for Improved Visual Encoding. IEEE Transactions on Visualization and Computer Graphics, 19(1): 130-140, 2013.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#outline">Outline</a></li>
      <li>
<a href="#background">1. Background</a><ul class="nav nav-pills nav-stacked">
<li><a href="#data-access">Data access</a></li>
      <li><a href="#data-structure-and-types">Data Structure and Types</a></li>
      <li><a href="#raster-layer-descriptions">Raster Layer Descriptions</a></li>
      </ul>
</li>
      <li>
<a href="#projection-and-loading-rasters">2. Projection and Loading Rasters</a><ul class="nav nav-pills nav-stacked">
<li><a href="#projection">Projection</a></li>
      <li><a href="#loading-rasters">Loading Rasters</a></li>
      </ul>
</li>
      <li>
<a href="#mapping-occurrence-and-abundance">3. Mapping Occurrence and Abundance</a><ul class="nav nav-pills nav-stacked">
<li><a href="#projections">Projections</a></li>
      <li><a href="#mapping-occurrence">Mapping Occurrence</a></li>
      <li><a href="#calculating-abundance-bins">Calculating Abundance Bins</a></li>
      <li><a href="#mapping-abundance">Mapping Abundance</a></li>
      <li><a href="#mapping-abundance-confidence-intervals">Mapping Abundance Confidence Intervals</a></li>
      </ul>
</li>
      <li><a href="#extracting-trajectories-with-uncertainty">4. Extracting Trajectories with Uncertainty</a></li>
      <li>
<a href="#conversion">5. Conversion</a><ul class="nav nav-pills nav-stacked">
<li><a href="#references">References</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://twitter.com/tom_auer">Tom Auer</a>, Daniel Fink, <a href="http://strimas.com">Matthew Strimas-Mackey</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
